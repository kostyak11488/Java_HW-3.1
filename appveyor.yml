version: 1.0.{build}
skip_branch_with_pr: true

image: Ubuntu2204

environment:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"

install:
  - sudo apt-get update
  - sudo apt-get install -y openjdk-11-jdk wget unzip curl lsof gnupg
  - java -version

build_script:
  - chmod +x gradlew
  - ./gradlew clean build -x test

test_script:
  - echo "=== System info ==="
  - java -version
  - ls -la artifacts/
  - file artifacts/app-replan-delivery.jar
  - echo "Installing Chrome..."
  - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
  - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
  - sudo apt-get update
  - sudo apt-get install -y google-chrome-stable
  - echo "Chrome installed"
  - google-chrome --version
  - echo "Killing any existing processes on port 9999..."
  - sudo lsof -ti:9999 | xargs kill -9 2>/dev/null || true
  - sleep 2
  - echo "Starting application..."
  - java -jar artifacts/app-replan-delivery.jar > app.log 2>&1 &
  - APP_PID=$!
  - echo $APP_PID > app.pid
  - sleep 15
  - echo "=== Server status ==="
  - ps aux | grep java | grep -v grep || echo "Java process not found"
  - echo "=== App Log ==="
  - cat app.log || echo "No log file"
  - echo "Testing connectivity..."
  - curl -v http://localhost:9999 2>&1 | head -20 || echo "Connection failed"
  - echo "Running tests..."
  - ./gradlew test --tests ReplanDeliveryTest -Dselenide.headless=true -Dselenide.browser=chrome -Dselenide.timeout=15000 -Dselenide.pageLoadTimeout=15000

after_test:
  - echo "=== Test Report ==="
  - test -f build/reports/tests/test/index.html && echo "Test report generated" || echo "No test report"

artifacts:
  - path: build/reports/tests/test/
    name: TestResults
  - path: build/libs/
    name: Artifacts
  - path: app.log
    name: AppLog

on_finish:
  - bash: |
      echo "Cleanup..."
      if [ -f app.pid ]; then
        kill $(cat app.pid) 2>/dev/null || true
      fi
      sudo lsof -ti:9999 | xargs kill -9 2>/dev/null || true