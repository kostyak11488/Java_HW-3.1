version: 1.0.{build}
skip_branch_with_pr: true

image: Ubuntu2204

environment:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"

install:
  - sudo apt-get update
  - sudo apt-get install -y openjdk-11-jdk wget unzip curl
  - wget https://services.gradle.org/distributions/gradle-8.8-bin.zip
  - sudo mkdir /opt/gradle
  - sudo unzip gradle-8.8-bin.zip -d /opt/gradle
  - export PATH=$PATH:/opt/gradle/gradle-8.8/bin
  - java -version
  - gradle -version

build_script:
  - chmod +x gradlew
  - ./gradlew clean build

test_script:
  - echo "Installing Chrome..."
  - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
  - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
  - sudo apt-get update
  - sudo apt-get install -y google-chrome-stable
  - CHROMEDRIVER_VERSION="143.0.7357.124"
  - wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
  - sudo unzip /tmp/chromedriver.zip -d /usr/local/bin/
  - sudo chmod +x /usr/local/bin/chromedriver
  - google-chrome --version
  - chromedriver --version

  - echo "Starting application..."
  - java -jar artifacts/app-replan-delivery.jar > app.log 2>&1 &
  - echo $! > app.pid
  - sleep 10
  - curl -f http://localhost:9999 || (cat app.log && exit 1)

  - echo "Running tests..."
  - ./gradlew test --tests ReplanDeliveryTest \
    -Dselenide.headless=true \
    -Dselenide.browser=chrome \
    -Dselenide.timeout=15000 \
    -Dselenide.pageLoadTimeout=15000

after_test:
  - echo "Test completed"

artifacts:
  - path: build/reports/tests/test/
    name: TestResults
  - path: app.log
    name: AppLog

on_finish:
  - ps: |
      if (Test-Path app.pid) {
        $pid = Get-Content app.pid
        Stop-Process -Id $pid -Force 2>$null || true
      }
      Stop-Process -Name java -Force 2>$null || true