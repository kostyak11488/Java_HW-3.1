version: 1.0.{build}
skip_branch_with_pr: true

image: Ubuntu2204

environment:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"

install:
  - sudo apt-get update
  - sudo apt-get install -y openjdk-11-jdk wget unzip curl

build_script:
  - chmod +x gradlew
  - ./gradlew clean build

test_script:
  - echo "=== System info ==="
  - java -version
  - ls -la artifacts/
  - file artifacts/app-replan-delivery.jar || echo "JAR not found or not executable"

  - echo "Installing Chrome..."
  - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
  - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
  - sudo apt-get update
  - sudo apt-get install -y google-chrome-stable
  - CHROMEDRIVER_VERSION="143.0.7357.124"
  - wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
  - sudo unzip /tmp/chromedriver.zip -d /usr/local/bin/
  - sudo chmod +x /usr/local/bin/chromedriver
  - google-chrome --version
  - chromedriver --version

  - echo "Starting application..."
  - java -jar artifacts/app-replan-delivery.jar > app.log 2>&1 &
  - echo $! > app.pid
  - sleep 10

  - echo "=== Server status ==="
  - ps aux | grep java
  - netstat -tuln | grep 9999 || echo "Port 9999 not listening"
  - curl -v http://localhost:9999 2>&1 | head -20

  - if curl -f http://localhost:9999; then
    echo "✅ Server is UP"
    else
    echo "❌ Server is DOWN"
    echo "=== App Log ==="
    cat app.log || echo "No log"
    exit 1
    fi

  - echo "Running tests..."
  - ./gradlew test --tests ReplanDeliveryTest \
    -Dselenide.headless=true \
    -Dselenide.browser=chrome \
    -Dselenide.timeout=15000 \
    -Dselenide.pageLoadTimeout=15000

after_test:
  - echo "=== Test completed ==="

artifacts:
  - path: build/reports/tests/test/
    name: TestResults
  - path: app.log
    name: AppLog
  - path: app.pid
    name: AppPid

on_finish:
  - bash: |
      if [ -f app.pid ]; then
        kill $(cat app.pid) 2>/dev/null || true
      fi
      kill $(lsof -t -i:9999) 2>/dev/null || true